---
title: "Web scraping"
author: "Harriet Ware"
date: "February 7 2020"
output: 
  html_document:
    number_sections: true
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(rvest)
library(janitor)
library(geofacet)
```

## Question 1

Add a year column to `d_prescriptions`.

```{r}
d_prescriptions<-data.frame(state=character(),
                 state_abbreviation=character(), 
                 prescribing_rate=double(), 
                 year=double(),
                 stringsAsFactors=FALSE) 
```
## Getting all the other years

Now I want you to get data for 2008-2019 and save it into one big tibble. If you go to https://www.cdc.gov/drugoverdose/maps/rxrate-maps.html, on the right hand side there's hyperlinks to all the years under "U.S. State Prescribing Rate Maps". 

Click on 2009. Look at the url. Confirm that it's exactly the same format as the url for 2008, except the year has changed. This is useful, because we can just loop through in an automated way, changing the year as we go. 

## Question 2

Make a vector of the urls for each year, storing them as strings. 
```{r}
years<-c("2008","2009","2010","2011","2012","2013","2014","2015","2016","2017","2018","2019")
```
## Question 3

Extract the prescriptions data for the years 2008-2019, and store in the one tibble. Make sure you have a column for state, state abbreviation, prescription rate and year. Note if you are looping over years/urls (which is probably the easiest thing to do), it's good practice to include a `Sys.sleep(1)` at the end of your loop, so R waits for a second before trying again. 

```{r}

for(i in 2008:2016) {
cdcpage <- paste0("https://www.cdc.gov/drugoverdose/maps/rxstate",i,".html")
cdc <- read_html(cdcpage)
table_text <- cdc %>% 
  html_nodes("tr") %>% 
  html_text() 
rough_table <- table_text %>% 
  as_tibble() %>% 
  separate(value, into = c("state", "abbrev", "rate"), sep = "\n", extra = "drop") 
d_pres <- rough_table %>% 
  janitor::row_to_names(1) %>% 
  janitor::clean_names() %>% 
  rename(prescribing_rate = opioid_dispensing_rate_per_100) %>% 
  mutate(prescribing_rate = as.numeric(prescribing_rate),year=i) 
d_prescriptions<-rbind(d_prescriptions,d_pres)
Sys.sleep(1)
}

#new loop for 2017-2019 because the column names change
for(i in 2017:2019){
  cdcpage <- paste0("https://www.cdc.gov/drugoverdose/maps/rxstate",i,".html")
cdc <- read_html(cdcpage)
table_text <- cdc %>% 
  html_nodes("tr") %>% 
  html_text() 
rough_table <- table_text %>% 
  as_tibble() %>% 
  separate(value, into = c("state", "abbrev", "rate"), sep = "\n", extra = "drop") 
d_pres <- rough_table %>% 
  janitor::row_to_names(1) %>% 
  janitor::clean_names() %>% 
  rename(prescribing_rate = opioid_dispensing_rate_per_100,
         state_abbreviation=abbreviation) %>% 
  mutate(prescribing_rate = as.numeric(prescribing_rate),year=i) 
d_prescriptions<-rbind(d_prescriptions,d_pres)
Sys.sleep(1)
}

```
Plot prescriptions by state over time.
```{r}
ggplot(d_prescriptions, aes(year,prescribing_rate)) +
  geom_line() +
  facet_geo(~ state_abbreviation) +
  ylab("Prescribing Rate") + 
  xlab("Year") + 
  scale_x_continuous(breaks=c(2008,2019)) +
  scale_y_continuous(breaks=c(20,150)) +
  theme(
  axis.ticks = element_blank())
```
# Question 4: Install rstan and brms

We will be using the packages `rstan` and `brms` from next week. Please install these. Here's some instructions:

- https://github.com/paul-buerkner/brms
- https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started

In most cases it will be straightforward and may not need much more than `install.packages()`, but you might run into issues. Every Stan update seems to cause problems for different OS.

To make sure it works, run the following code:

```{r}
library(brms)

x <- rnorm(100)
y <- 1 + 2*x + rnorm(100)
d <- tibble(x = x, y= y)

mod <- brm(y~x, data = d)
summary(mod)

```

