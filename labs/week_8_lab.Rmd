---
title: "Git collaboration and hierarchical models"
author: "Harriet Ware"
date: "March 12 2021"
output: 
  pdf_document:
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(rstan)
library(bayesplot)
```

# Git collaboration

See github.

# Radon

The goal of this lab is to fit this model to the radon data:

$$
\begin{aligned}
y_{i} | \alpha_{j[i]} & \sim N\left(\alpha_{j[i]}+\beta x_{i}, \sigma_{y}^{2}\right), \text { for } i=1,2, \ldots, n \\
\alpha_{j} & \sim N\left(\gamma_{0}+\gamma_{1} u_{j}, \sigma_{\alpha}^{2}\right), \text { for } j=1,2, \ldots, J
\end{aligned}
$$

i.e. varying intercepts, fixed slope on floor. I want you to 

- reproduce the graph on slide 50. 
- plot samples from the posterior predictive distribution for a new household in county 2 with basement level measurement, compared to samples from the posterior distribution of the mean county effect in county 2 (i.e., a graph similar to slide 39).

Here's code to get the data into a useful format:

```{r}
# house level data
d <- read.table(url("http://www.stat.columbia.edu/~gelman/arm/examples/radon/srrs2.dat"), header=T, sep=",")

# deal with zeros, select what we want, make a fips variable to match on 
d <- d %>% 
  mutate(activity = ifelse(activity==0, 0.1, activity)) %>% 
  mutate(fips = stfips * 1000 + cntyfips) %>%   
  dplyr::select(fips, state, county, floor, activity)

# county level data
cty <- read.table(url("http://www.stat.columbia.edu/~gelman/arm/examples/radon/cty.dat"), header = T, sep = ",")
cty <- cty %>% mutate(fips = 1000 * stfips + ctfips) %>% dplyr::select(fips, Uppm)

# filter to just be minnesota, join them and then select the variables of interest. 
dmn <- d %>% 
  filter(state=="MN") %>% 
  dplyr::select(fips, county, floor, activity) %>% 
  left_join(cty)
head(dmn)

```

Note, in the model:

- $y_i$ is log(activity)
- $x_i$ is floor
- $u_i$ is log(Uppm)

So to complete this task successfully you will need to show me / produce:

- stan code for the model
- a plot like slide 39
- a plot like slide 50

Suggested steps

1. write Stan model (note, you will need samples from post pred distribution, either do in Stan or later in R)
2. Get data in stan format
3. Run the model
4. For $\alpha$ plot, get median estimates of alpha's, and the 2.5th and 97.5th percentiles. Also get the median (mean fine, easier to pull from summary) of the gamma0 and gamma1. You can then use `geom_abline()` to plot mean regression line. 
5. For the predicted y plot, you will need your posterior predictive samples for $y$'s and then just use `geom_density()`

```{r}
#Get data in stan format
dmn$y <- log(dmn$activity)
dmn$x <- dmn$floor
dmn$u <- log(dmn$Uppm)
u <- dmn%>%select(u)%>%distinct()%>%pull()
dmn$county_code <- as.numeric(as.factor(dmn$county))
J <- max(dmn$county_code)

stan_data <- list(N = nrow(dmn),
                  J = J,
                  county = dmn$county_code,
                  y = dmn$y,
                  x = dmn$floor,
                  u = u)
```

```{r}
#Run the model
mod <- stan(data = stan_data, 
             file = "code/models/radon.stan",
             iter = 1000,
             seed = 243)

summary(mod)$summary[c("beta", "sigma_alpha","sigma","gamma0","gamma1"),]
```

```{r}
traceplot(mod,pars=c("beta","sigma_alpha","sigma","gamma0","gamma1"))
```

```{r}
#alpha plot like slide 50
alphas<-data.frame(summary(mod)$summary[6:90,c("50%","2.5%","97.5%")])
alphas$u=u
gamma0<-summary(mod)$summary[4,"50%"]
gamma1<-summary(mod)$summary[5,"50%"]

ggplot(alphas,aes(x=u,y=X50.))+geom_point()+
  geom_abline(intercept=gamma0,slope=gamma1)+
  geom_pointrange(aes(ymin=X2.5., ymax=X97.5.),fatten=1)+
  xlab("log(uranium)")+
  ylab("alpha")+
  theme_bw()
```

```{r}
#predicted y plot like slide 39
post_samples <- extract(mod)
yrep <- post_samples$y_rep
sampy <- sample(yrep, 300)
alpha <- post_samples$alpha[,2]
sampa <- sample(alpha,300)

ggplot()+geom_density(aes(x=sampa,fill="blue"),alpha=0.5)+
  geom_density(aes(x=sampy,fill="red"),alpha=0.5)+
  xlab("log radon")+
  scale_fill_manual(name="",values = c("blue","red"),labels=c("alpha_2","y_tilde_2"))+
  theme_bw()
  
```