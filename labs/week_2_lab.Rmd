---
title: "EDA and data visualization"
author: "Harriet Ware"
date: "January 22 2021"
output: 
    pdf_document:
      number_sections: true
      toc: false
      latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

Load in all the packages we need:

```{r}
library(opendatatoronto)
library(tidyverse)
library(stringr)
library(skimr)
library(visdat)
library(janitor)
library(lubridate)
library(ggrepel)
```

# Lab Exercises

*1. Using the `opendatatoronto` package, download the data on mayoral campaign contributions for 2014. Hints:*
    *+ find the ID code you need for the package you need by searching for 'campaign' in the `all_data` tibble above*
    *+ you will then need to `list_package_resources` to get ID for the data file*
    *+ note: the 2014 file you will get from `get_resource` has a bunch of different campaign contributions, so just keep the data that relates to the Mayor election*
    
```{r}
res <- list_package_resources("f6651a40-2f52-46fc-9e04-b760c16edd5c") 
# obtained code from searching data frame above
campaign_2014 <- get_resource("d99bb1f3-949a-4497-bb96-c93bbd203130") 
# obtained code from searching data frame above
mayor_2014<-campaign_2014[2][[1]]
```
*2. Clean up the data format (fixing the parsing issue and standardizing the column names using `janitor`)*
```{r}
mayor_2014<-mayor_2014 %>%
  row_to_names(row_number = 1)
mayor_2014<-clean_names(mayor_2014)
```

*3. Summarize the variables in the dataset. Are there missing values, and if so, should we be worried about them? Is every variable in the format it should be? If not, create new variable(s) that are in the right format.*

```{r}
skim(mayor_2014)
```

We can make the contribution amount variable numeric instead of character.

```{r}
mayor_2014<-mayor_2014%>%mutate(contribution_amount = as.numeric(contribution_amount))

skim(mayor_2014)
```

Check values of variables.

```{r}
unique(mayor_2014$contribution_type_desc)
unique(mayor_2014$contributor_type_desc)
unique(mayor_2014$candidate)
unique(mayor_2014$office)
unique(mayor_2014$relationship_to_candidate)
```

Everything looks good above.

Now look to see how many NAs by variable.

```{r}
vis_miss(mayor_2014)
```

It seems like the key variables are all populated, so we don't need to worry about missing values.

*4. Visually explore the distribution of values of the contributions. What contributions are notable outliers? Do they share a similar characteristic(s)? It may be useful to plot the distribution of contributions without these outliers to get a better sense of the majority of the data.* 

First plot the distribution of all observations.

```{r}
ggplot(data = mayor_2014, aes(contribution_amount)) + 
  geom_histogram(fill = "lightblue", color = "navy") +
  ggtitle("Contribution amount, Mayoral campaign for 2014") + 
  xlab("contribution amount ($)")
```
We can summarize the percentiles of the distribution to get a sense of the outliers with large contribution amounts.

```{r}
mayor_2014 %>%
  summarize(contribution_amount_q = quantile(contribution_amount, 
            probs=c(0,.25,.5,.75,.99,1),na.rm = T))
```

The 99% percentile of the distribution of contribution amounts is $2500. We can look more closely at the top 1%.

```{r}
mayor_2014 %>% 
  filter(contribution_amount>2500)
```
We see that all but one of the contributions greater than $2500 come from the candidates themselves. The remaining one comes from photography services. We can plot the distribution of contributions without these 11 outliers to get a better sense of the majority of the data. 

```{r}
mayor_2014_to_plot<-mayor_2014 %>% 
  filter(contribution_amount<=2500)
ggplot(data = mayor_2014_to_plot, aes(contribution_amount)) + 
  geom_histogram(fill = "lightblue", color = "navy") +
  ggtitle("Contribution amount up to $2500, Mayoral campaign for 2014") + 
  xlab("contribution amount ($)")
```
Now we see that the distribution is right-skewed with the median contribution around $300.

*5. List the top five candidates in each of these categories:*
    *+ total contributions*
    *+ mean contribution*
    *+ number of contributions*

```{r}
mayor_2014 %>% group_by(candidate) %>%
  summarize(total_contribution = sum(contribution_amount, na.rm = T)) %>%
  slice_max(total_contribution,n=5)
```
```{r}
mayor_2014 %>% group_by(candidate) %>%
  summarize(mean_contribution = mean(contribution_amount, na.rm = T)) %>%
  slice_max(mean_contribution,n=5)
```
```{r}
mayor_2014 %>% group_by(candidate) %>%
  summarize(num_contribution = n()) %>%
  slice_max(num_contribution,n=5)
```
*6. Repeat 5 but without contributions from the candidates themselves.*
```{r}
mayor_2014 %>% filter(relationship_to_candidate!="Candidate"|is.na(relationship_to_candidate)) %>%
  group_by(candidate) %>%
  summarize(total_contribution = sum(contribution_amount, na.rm = T)) %>%
  slice_max(total_contribution,n=5)
```
```{r}
mayor_2014 %>% filter(relationship_to_candidate!="Candidate"|is.na(relationship_to_candidate)) %>%
  group_by(candidate) %>%
  summarize(mean_contribution = mean(contribution_amount, na.rm = T)) %>%
  slice_max(mean_contribution,n=5)
```
```{r}
mayor_2014 %>% filter(relationship_to_candidate!="Candidate"|is.na(relationship_to_candidate)) %>%
  group_by(candidate) %>%
  summarize(num_contribution = n()) %>%
  slice_max(num_contribution,n=5)
```

*7. How many contributors gave money to more than one candidate?* 
```{r}
mayor_2014 %>%
  group_by(contributors_name) %>%
  summarise(num_candidate=n_distinct(candidate)) %>%
  filter(num_candidate>1)
```
184 contributors gave money to more than one candidate.

