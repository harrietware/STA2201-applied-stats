---
title: "Missing data and temporal models"
author: "Harriet Ware"
date: "March 26 2021"
output: 
  pdf_document
---

# Child mortality in Sri Lanka

In this lab you will be fitting a couple of different models to the data about child mortality in Sri Lanka, which was used in the lecture. Here's the data and the plot from the lecture:

```{r}
library(tidyverse)
library(here)
library(rstan)
library(tidybayes)

lka <- read_csv(here("data/lka.csv"))
ggplot(lka, aes(year, logit_ratio)) +
  geom_point(aes( color = source)) + 
  geom_line(aes( color = source), lty = 2) + 
  geom_ribbon(aes(ymin = logit_ratio - se,
                  ymax = logit_ratio + se,
                  fill =  source), alpha = 0.1) +
  theme_bw()+
  labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka", y = "log ratio")
```

# Fitting a linear model 

Let's firstly fit a linear model in time to these data. Here's the code to do this:

```{r}
observed_years <- lka$year
years <- min(observed_years):max(observed_years)
nyears <- length(years)

stan_data <- list(y = lka$logit_ratio, year_i = observed_years - years[1]+1, 
                  T = nyears, years = years, N = length(observed_years), 
                  mid_year = mean(years), se = lka$se)

mod <- stan(data = stan_data,
             file = here("labs","code/models/lka_linear_me.stan"))

```

Extract the results:

```{r}
res <- mod %>% 
  gather_draws(mu[t]) %>% 
  median_qi() %>% 
  mutate(year = years[t])
```


Plot the results:

```{r}
ggplot(lka, aes(year, logit_ratio)) +
  geom_point(aes( color = source)) + 
  geom_line(aes( color = source), lty = 2) + 
  geom_ribbon(aes(ymin = logit_ratio - se, 
                  ymax = logit_ratio + se, 
                  fill =  source), alpha = 0.1) + 
  theme_bw()+
  geom_line(data = res, aes(year, .value)) + 
  geom_ribbon(data = res, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
  theme_bw()+
  labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
       y = "log ratio", subtitle = "Linear fit shown in black")
```

## Question 1

Project the linear model above out 10 years past the last observation by adding a `generated quantities` block in Stan (do the projections based on the expected value $\mu$). Plot the resulting projections on a graph similar to that above. 

# Random walks

The `lka_rw_me` Stan file gives you code to estimate and project a random walk model on the Sri Lankan data. 

## Question 2

Alter the first order random walk model to estimate and project a second-order random walk model (RW2). 

## Question 3

Run the first order and second order random walk models, including projections out 10 years. Compare these estimates with the linear fit by plotting everything on the same graph. 

```{r}
stan_data <- list(y = lka$logit_ratio, year_i = observed_years - years[1]+1, 
                  T = nyears, years = years, N = length(observed_years), 
                  P=10, se = lka$se)

mod_rw <- stan(data = stan_data,
             file = here("labs","code/models/lka_rw_me.stan"))

mod_rw2 <- stan(data = stan_data,
             file = here("labs","code/models/lka_rw_me2.stan"))

```
Extract the results:

```{r}
res_rw <- mod_rw %>% 
  gather_draws(mu[t]) %>% 
  median_qi() %>% 
  mutate(year = years[t])

res_rw2 <- mod_rw2 %>% 
  gather_draws(mu[t]) %>% 
  median_qi() %>% 
  mutate(year = years[t])
```


Plot the results:

```{r}
ggplot(lka, aes(year, logit_ratio)) +
  geom_point(aes( color = source)) + 
  geom_line(aes( color = source), lty = 2) + 
  geom_ribbon(aes(ymin = logit_ratio - se, 
                  ymax = logit_ratio + se, 
                  fill =  source), alpha = 0.1) + 
  theme_bw()+
  geom_line(data = res, aes(year, .value),linetype='solid') + 
  geom_line(data = res_rw, aes(year, .value),linetype='longdash')+
  geom_line(data = res_rw2, aes(year, .value),linetype='dotdash')+
  theme_bw()+
  labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
       y = "log ratio", subtitle = "Linear fit shown as solid black\nAR1 and AR2 fits shown as dashed black")

```

## Question 4

Rerun the RW2 model excluding the VR data. Briefly comment on the differences between the two data situations. 

```{r}
lka2<-lka%>%filter(source!="VR")
observed_years <- lka2$year
years <- min(observed_years):max(observed_years)
nyears <- length(years)

stan_data <- list(y = lka2$logit_ratio, year_i = observed_years - years[1]+1, 
                  T = nyears, years = years, N = length(observed_years), 
                  P=10, se = lka2$se)

mod_rw2_vr <- stan(data = stan_data,
             file = here("labs","code/models/lka_rw_me2.stan"))

```
As expected, the fit including VR tracks the VR data closely, while the fit excluding VR estimates a fairly straight line through the VR data years.

```{r}
res_rw2_vr <- mod_rw2_vr %>% 
  gather_draws(mu[t]) %>% 
  median_qi() %>% 
  mutate(year = years[t])
ggplot(lka, aes(year, logit_ratio)) +
  geom_point(aes( color = source)) + 
  geom_line(aes( color = source), lty = 2) + 
  geom_ribbon(aes(ymin = logit_ratio - se, 
                  ymax = logit_ratio + se, 
                  fill =  source), alpha = 0.1) + 
  theme_bw()+
  geom_line(data = res_rw2_vr, aes(year, .value),linetype='solid') + 
  geom_line(data = res_rw2, aes(year, .value),linetype='dotdash')+
  theme_bw()+
  labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
       y = "log ratio", subtitle = "AR2, No VR shown as solid black\nAR2, With VR shown as dashed black")

```

## Question 5

Briefly comment on which model you think is most appropriate, or an alternative model that would be more appropriate in this context. 